import type { NextApiRequest, NextApiResponse } from 'next'\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  if (req.method !== 'POST') {\n    res.setHeader('Allow', 'POST')\n    return res.status(405).end('Method Not Allowed')\n  }\n\n  const payload = req.body || {}\n  const { animeId, provider, url, timestamp } = payload\n\n  const ip = (req.headers['x-forwarded-for'] as string) || req.socket.remoteAddress || (req.headers['x-real-ip'] as string) || null\n  const ua = (req.headers['user-agent'] as string) || null\n\n  try {\n    // Try to store with Prisma if available\n    // eslint-disable-next-line @typescript-eslint/no-var-requires\n    const { PrismaClient } = require('@prisma/client')\n    const prisma = new PrismaClient()\n    await prisma.$connect()\n\n    await prisma.affiliateClick.create({\n      data: {\n        animeId: animeId ? Number(animeId) : null,\n        affiliateProvider: provider ?? null,\n        url: url ?? null,\n        ip: ip ?? null,\n        userAgent: ua ?? null,\n        createdAt: timestamp ? new Date(timestamp) : new Date()\n      }\n    })\n\n    await prisma.$disconnect()\n    return res.status(204).end()\n  } catch (err) {\n    console.log('Affiliate click (fallback log):', { animeId, provider, url, timestamp, ip, ua })\n    return res.status(204).end()\n  }\n}